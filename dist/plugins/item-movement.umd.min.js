!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ItemMovement={})}(this,(function(t){"use strict";const e="chart-timeline-items-row-item";const i="config.plugin.ItemMovement";class a{constructor(t,e){this.onDestroy=[],this.scrollWaiting=0,this.vido=t,this.state=t.state,this.api=t.api,this.data=function(t={}){const e={onStart:({items:t})=>t.after,onMove:({items:t})=>t.after,onEnd:({items:t})=>t.after},i={start:({startTime:t,time:e})=>t.startOf(e.period),end:({endTime:t,time:e})=>t.endOf(e.period)},a={speed:{horizontal:1,vertical:1},edgeThreshold:{horizontal:100,vertical:100}},s=Object.assign({enabled:!0,dependant:!0,debug:!1,state:"",bodyClass:"gstc-items-moving",itemClass:"",movement:{x:0,y:0,time:0},threshold:{horizontal:10,vertical:10},initialItems:[],initialDependant:[],initialItemsData:{},initialDependantData:{},clickedItem:null,clickedItemData:null,initialVerticalScroll:null,initialHorizontalScroll:null,isMoving:!1,events:Object.assign({},e),snapToTime:Object.assign({},i),autoScroll:Object.assign({},a)},t);return t.snapToTime&&(s.snapToTime=Object.assign(Object.assign({},i),t.snapToTime)),t.events&&(s.events=Object.assign(Object.assign({},e),t.events)),t.autoScroll&&(s.autoScroll=Object.assign(Object.assign({},a),t.autoScroll),t.autoScroll.edgeThreshold&&(s.autoScroll.edgeThreshold=Object.assign(Object.assign({},a.edgeThreshold),t.autoScroll.edgeThreshold)),t.autoScroll.speed&&(s.autoScroll.speed=Object.assign(Object.assign({},a.speed),t.autoScroll.speed))),s}(e),this.data.itemClass||(this.data.itemClass=this.api.getClass("timeline-chart-items-row-item")+"--moving"),this.destroy=this.destroy.bind(this),this.itemUpdateAction=this.itemUpdateAction.bind(this),this.onDestroy.push(this.state.subscribe("$data.elements.chart-timeline",(t=>this.timelineElement=t))),this.updateData(),this.onDestroy.push(this.state.subscribe("config.plugin.ItemMovement",(t=>{t.enabled&&t.isMoving?document.body.classList.add(t.bodyClass):document.body.classList.remove(t.bodyClass),this.data=t}))),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this),this.onDestroy.push(this.state.subscribe("config.plugin.TimelinePointer",(t=>{this.pointerData=t,this.onPointerData()})))}destroy(){this.onDestroy.forEach((t=>t())),this.api.pluginDestroyed("ItemMovement")}updateData(){this.state.update(i,this.data)}getSelectedItems(t=!1){return this.state.get(`config.plugin.Selection.selected.${e}`).map((e=>{let i=this.api.getItem(e);if(t)for(const t of this.data.initialItems)if(t.id===e){i=t;break}return this.api.mergeDeep({},i)}))}getSelectedItemsData(t){const e={};for(const i of t)e[i.id]=this.api.mergeDeep({},this.api.getItemData(i.id));return e}getEventArgument(t){const e=this.api.getAllItems(),i=[];for(const a of t)i.push(this.api.mergeDeep({},e[a.id]));return{items:{initial:this.data.initialItems,before:i,after:t,targetData:this.pointerData.targetData},vido:this.vido,state:this.state,time:this.state.get("$data.chart.time")}}getDependantItems(){const t=[],e=this.api.getItemsData();for(const i of this.data.initialItems)for(const a of e[i.id].dependant)t.includes(a)||t.push(a);const i=this.state.get("config.chart.items");return t.map((t=>i[t])).map((t=>this.api.mergeDeep({},t)))}getDependantItemsData(){const t={},e=this.api.getItemsData();for(const i of this.data.initialDependant)t[i.id]=this.api.mergeDeep({},e[i.id]);return t}moveDependantItems(t,e){if(!this.data.dependant)return e;const i=this.api.getItemsData(),a=this.state.get("config.chart.time");for(const s of t){const t=this.data.initialItems.find((t=>t.id===s.id)),o=this.data.initialItemsData[t.id],n=i[s.id];if(n.dependant.length)for(const t of n.dependant){this.data.initialDependant.find((e=>e.id===t));const i=this.data.initialDependantData[t],s=n.time.endDate.diff(o.time.endDate,"millisecond"),l=i.time.startDate.add(s,"millisecond"),d=i.time.endDate.add(s,"millisecond"),r=n.position.right-i.position.right,h=n.position.viewTop-i.position.viewTop,p=this.data.snapToTime.start({startTime:l,time:a,movement:{x:r,y:h,time:s},vido:this.vido});e=e.update(`config.chart.items.${t}.time`,(t=>(t.start=p.valueOf(),t.end=d.valueOf(),t))),e=e.update(`$data.chart.items.${t}.time`,(t=>(t.startDate=p,t.endDate=d,t)))}}return e}dispatchEvent(t,e,i=null){"onStart"===t&&(this.api.muteMethod("fixOverlapped"),this.api.muteMethod("fullReload"),this.api.muteMethod("measureRows"),this.api.muteMethod("getLastPageRowsHeight"),this.api.muteMethod("calculateVerticalScrollArea"),this.api.muteMethod("heightChange"),this.api.muteMethod("calculateRowsHeight"),this.api.muteMethod("calculateVisibleRowsHeights"),this.api.muteMethod("updateVisibleItemsListener"),this.api.muteMethod("prepareExpanded"),0===this.data.autoScroll.speed.horizontal&&0===this.data.autoScroll.speed.vertical&&(this.api.muteMethod("generateVisibleRowsAndItems"),this.api.muteMethod("prepareExpanded"),this.api.muteMethod("recalculateTimes"))),"onEnd"===t&&(this.api.unmuteMethod("fixOverlapped"),this.api.unmuteMethod("heightChange"),this.api.unmuteMethod("calculateVerticalScrollArea"),this.api.unmuteMethod("getLastPageRowsHeight"),this.api.unmuteMethod("fullReload"),this.api.unmuteMethod("measureRows"),this.api.unmuteMethod("calculateRowsHeight"),this.api.unmuteMethod("calculateVisibleRowsHeights"),this.api.unmuteMethod("updateVisibleItemsListener"),this.api.unmuteMethod("prepareExpanded"),0===this.data.autoScroll.speed.horizontal&&0===this.data.autoScroll.speed.vertical&&(this.api.unmuteMethod("generateVisibleRowsAndItems"),this.api.unmuteMethod("prepareExpanded"),this.api.unmuteMethod("recalculateTimes"))),e=e.map((t=>this.api.mergeDeep({},t)));const a=this.data.events[t](this.getEventArgument(e));let s=this.state.multi(!0),o=!1;const n=this.state.get("config.chart.items");for(let t of a){t=this.api.mergeDeep({},t);const e=n[t.id];let a=!1;t.time.start===e.time.start&&t.time.end===e.time.end||(o=!0,a=!0,s=s.update(`config.chart.items.${t.id}.time`,Object.assign({},t.time)));let l=!1;e.rowId!==t.rowId&&(l=!0,s=s.update(`config.chart.items.${t.id}.rowId`,t.rowId),this.api.updateItemRowMapForItem(t.id,t.rowId)),i&&(a||l)&&(s=s.update(`$data.chart.items.${t.id}`,this.api.mergeDeep({},i[t.id])))}"onStart"!==t&&"onMove"!==t||!o||(s=this.moveDependantItems(a,s)),s.done(),"onEnd"===t&&this.api.main.partialReload(!1)}getItemsForDiff(){const t=this.getSelectedItems()[0],e=this.data.initialItems.find((e=>e.id===t.id));return{modified:t,original:e}}onPointerData(){this.data.enabled&&("down"===this.pointerData.pointerState&&this.pointerData.targetType===e?this.api.plugins.TimelinePointer.isLocked("down")||this.triggerDown():"move"===this.pointerData.pointerState&&this.pointerData.targetType===e?"item-movement"===this.api.plugins.TimelinePointer.isLocked("move")&&this.onPointerMove():"up"===this.pointerData.pointerState&&this.pointerData.targetType===e&&"item-movement"===this.api.plugins.TimelinePointer.isLocked("up")&&this.onPointerUp())}triggerDown(){document.body.classList.add(this.data.bodyClass),this.api.plugins.TimelinePointer.lock("down","item-movement"),this.api.plugins.TimelinePointer.lock("move","item-movement"),this.api.plugins.TimelinePointer.lock("up","item-movement"),this.data.isMoving=!0,this.data.initialItems=this.getSelectedItems(),this.data.initialDependant=this.getDependantItems(),this.data.initialItemsData=this.getSelectedItemsData(this.data.initialItems),this.data.initialDependantData=this.getDependantItemsData(),this.data.clickedItem=this.api.mergeDeep({},this.pointerData.targetData),this.data.clickedItemData=this.api.mergeDeep({},this.api.getItemData(this.data.clickedItem.id)),this.data.initialVerticalScroll=this.api.mergeDeep({},this.state.get("$data.scroll.vertical")),this.data.initialHorizontalScroll=this.api.mergeDeep({},this.state.get("$data.scroll.horizontal")),this.scrollWaiting=0,""!==this.data.state&&"end"!==this.data.state||(this.data.state="move"),this.dispatchEvent("onStart",this.data.initialItems),this.updateData()}scrollLeft(){if(this.data.autoScroll.speed.horizontal&&!this.state.get("config.chart.time.calculatedZoomMode")){if(this.scrollWaiting++,this.data.autoScroll.speed.horizontal<0){if(this.scrollWaiting-1<Math.abs(this.data.autoScroll.speed.horizontal))return;const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex-1)}else if(this.data.autoScroll.speed.horizontal>0){const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex-this.data.autoScroll.speed.horizontal)}this.scrollWaiting=0}}scrollRight(){if(this.data.autoScroll.speed.horizontal&&!this.state.get("config.chart.time.calculatedZoomMode")){if(this.scrollWaiting++,this.data.autoScroll.speed.horizontal<0){if(this.scrollWaiting-1<Math.abs(this.data.autoScroll.speed.horizontal))return;const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex+1)}else if(this.data.autoScroll.speed.horizontal>0){const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex+this.data.autoScroll.speed.horizontal)}this.scrollWaiting=0}}scrollTop(){if(this.data.autoScroll.speed.vertical){if(this.scrollWaiting++,this.data.autoScroll.speed.vertical<0){if(this.scrollWaiting-1<Math.abs(this.data.autoScroll.speed.vertical))return;const t=this.api.getScrollTop();this.api.setScrollTop(t.dataIndex-1)}else if(this.data.autoScroll.speed.vertical>0){const t=this.api.getScrollTop();this.api.setScrollTop(t.dataIndex-this.data.autoScroll.speed.vertical)}this.scrollWaiting=0}}scrollBottom(){if(this.data.autoScroll.speed.vertical){if(this.scrollWaiting++,this.data.autoScroll.speed.vertical<0){if(this.scrollWaiting-1<Math.abs(this.data.autoScroll.speed.vertical))return;const t=this.api.getScrollTop();this.api.setScrollTop(t.dataIndex+1)}else if(this.data.autoScroll.speed.vertical>0){const t=this.api.getScrollTop();this.api.setScrollTop(t.dataIndex+this.data.autoScroll.speed.vertical)}this.scrollWaiting=0}}autoScroll(){if(!this.timelineElement)return;const t=this.pointerData.currentPosition.x,e=this.pointerData.currentPosition.y,i=this.state.get("$data.chart.dimensions");t<this.data.autoScroll.edgeThreshold.horizontal?this.scrollLeft():t>i.widthWithoutScrollBar-this.data.autoScroll.edgeThreshold.horizontal?this.scrollRight():e<this.data.autoScroll.edgeThreshold.vertical?this.scrollTop():e>i.innerHeight-this.data.autoScroll.edgeThreshold.vertical&&this.scrollBottom()}moveItemVertically(t,e){const i=this.state.get("$data.scroll.vertical").absolutePosPx-this.data.initialVerticalScroll.absolutePosPx,a=this.pointerData.currentPosition.y-this.pointerData.initialPosition.y,s=this.data.clickedItemData.position.viewTop-this.pointerData.initialPosition.y-this.data.clickedItemData.position.rowTop;let o=e.position.top+a+i-s;o<0&&(o=0);const n=this.api.getRowInfoFromTop(o);n.row.id!==t.rowId&&(t.rowId=n.row.id,e.position.viewTop=this.api.getRowViewTop(t.rowId),e.position.rowTop=0)}onPointerMove(){if(!this.data.enabled)return;if(!this.data.isMoving)return;const{original:t,modified:e}=this.getItemsForDiff();if(!t)return;const i=this.data.movement=Object.assign(Object.assign({},this.pointerData.movement),{time:e.time.start-t.time.start});"move"!==this.data.state&&"start"!==this.data.state||(this.data.state="move");const a=this.getSelectedItems(!0),s={},o=this.state.get("$data.chart.time"),n=[],l=this.api.time.date(this.api.time.getTimeFromOffsetPx(this.pointerData.initialPosition.x,!0,o)),d=this.data.snapToTime.start({startTime:l,time:o,movement:i,vido:this.vido}),r=this.api.time.date(this.api.time.getTimeFromOffsetPx(this.pointerData.currentPosition.x,!0,o)),h=this.data.snapToTime.start({startTime:r,time:o,movement:i,vido:this.vido}),p=this.api.time.getDatesDiffPx(d,h,o,!0);for(let t=0,e=a.length;t<e;t++){const e=this.api.mergeDeep({},a[t]),l=this.api.mergeDeep({},this.data.initialItemsData[e.id]);this.moveItemVertically(e,l);const d=l.position.left+p,r=this.api.time.getTimeFromOffsetPx(d,!0,o),h=this.api.time.date(r),m=this.data.snapToTime.start({startTime:h,time:o,movement:i,vido:this.vido});l.position.left=this.api.time.getViewOffsetPxFromDates(m,!1,o);const c=l.position.left+l.width,u=this.api.time.date(this.api.time.getTimeFromOffsetPx(c,!0,o)),g=this.data.snapToTime.end({endTime:u,time:o,movement:i,vido:this.vido});l.position.right=this.api.time.getViewOffsetPxFromDates(g,!1,o),e.time.start=m.valueOf(),e.time.end=g.valueOf(),l.time.startDate=m,l.time.endDate=g,l.position.right=this.api.time.getGlobalOffsetPxFromDates(g,o),s[e.id]=l,n.push(e)}this.dispatchEvent("onMove",n,s),this.autoScroll(),this.updateData()}onEnd(){const t=this.getSelectedItems();this.dispatchEvent("onEnd",t)}onPointerUp(){document.body.classList.remove(this.data.bodyClass),this.data.enabled&&this.data.isMoving&&("move"===this.data.state&&(this.data.state="end"),this.data.isMoving=!1,this.onEnd(),this.updateData(),this.api.plugins.TimelinePointer.unlock("down"),this.api.plugins.TimelinePointer.unlock("move"),this.api.plugins.TimelinePointer.unlock("up"))}itemUpdateAction(t,e){this.data.initialItems.find((t=>t.id===e.item.id))&&this.data.isMoving?t.classList.add(this.data.itemClass):t.classList.remove(this.data.itemClass)}}t.Plugin=function(t={}){return function(e){const s=e.api;if(!s.isPluginInitialized("TimelinePointer"))throw new Error("TimelinePointer plugin must be initialized before ItemMovement plugin.");if(!s.isPluginInitialized("Selection"))throw new Error("Selection plugin must be initialized before ItemMovement plugin.");const o=e.state.get(i);o&&(t=e.api.mergeDeep({},t,o));const n=new a(e,t);return s.pluginInitialized("ItemMovement"),n.destroy}},Object.defineProperty(t,"__esModule",{value:!0})}));
