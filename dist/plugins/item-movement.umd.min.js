!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ItemMovement={})}(this,(function(t){"use strict";const e="config.plugin.ItemMovement";class i{constructor(t,e){this.onDestroy=[],this.vido=t,this.state=t.state,this.api=t.api,this.data=function(t={}){const e={onStart:({items:t})=>t.after,onMove:({items:t})=>t.after,onEnd:({items:t})=>t.after},i={start:({startTime:t,time:e})=>t.startOf(e.period)},a=Object.assign({enabled:!0,dependant:!0,debug:!1,state:"",bodyClass:"gstc-items-moving",itemClass:"",initialPosition:{x:0,y:0},currentPosition:{x:0,y:0},movement:{x:0,y:0,time:0},threshold:{horizontal:10,vertical:10},initialItems:[],initialDependant:[],initialItemsData:{},initialDependantData:{},targetData:null,isMoving:!1,triggerDown:!1,events:Object.assign({},e),snapToTime:Object.assign({},i)},t);return t.snapToTime&&(a.snapToTime=Object.assign(Object.assign({},i),t.snapToTime)),t.events&&(a.events=Object.assign(Object.assign({},e),t.events)),a}(e),this.data.itemClass||(this.data.itemClass=this.api.getClass("timeline-chart-items-row-item")+"--moving"),this.destroy=this.destroy.bind(this),this.itemUpdateAction=this.itemUpdateAction.bind(this),this.itemAction=this.itemAction.bind(this),this.updateData(),this.onDestroy.push(this.state.subscribe("config.plugin.ItemMovement",t=>{t.enabled&&t.isMoving?document.body.classList.add(t.bodyClass):document.body.classList.remove(t.bodyClass),this.data=t})),this.onDestroy.push(this.state.update("config.actions.chart-timeline-items-row-item",t=>(t.includes(this.itemAction)||t.push(this.itemAction),t))),this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerMove=t.schedule(this.onPointerMove),this.onPointerUp=this.onPointerUp.bind(this),document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerup",this.onPointerUp)}destroy(){this.state.update("config.actions.chart-timeline-items-row-item",t=>t.filter(t=>t!==this.itemAction)),this.onDestroy.forEach(t=>t()),document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerup",this.onPointerUp)}updateData(){this.state.update(e,this.data)}getSelectedItems(){return this.state.get("config.plugin.Selection.selected.chart-timeline-items-row-item").map(t=>this.api.mergeDeep({},this.api.getItem(t)))}getSelectedItemsData(t){const e={};for(const i of t)e[i.id]=this.api.mergeDeep({},this.api.getItemData(i.id));return e}getEventArgument(t){const e=this.api.getAllItems(),i=[];for(const a of t)i.push(this.api.mergeDeep({},e[a.id]));return{items:{initial:this.data.initialItems,before:i,after:t,targetData:this.data.targetData},vido:this.vido,state:this.state,time:this.state.get("$data.chart.time")}}getDependantItems(){const t=[],e=this.api.getItemsData();for(const i of this.data.initialItems)for(const a of e[i.id].dependant)t.includes(a)||t.push(a);const i=this.state.get("config.chart.items");return t.map(t=>i[t]).map(t=>this.api.mergeDeep({},t))}getDependantItemsData(){const t={},e=this.api.getItemsData();for(const i of this.data.initialDependant)t[i.id]=this.api.mergeDeep({},e[i.id]);return t}moveDependantItems(t,e){if(!this.data.dependant)return e;const i=this.api.getItemsData(),a=this.state.get("config.chart.time");for(const s of t){const t=this.data.initialItems.find(t=>t.id===s.id),n=this.data.initialItemsData[t.id],o=i[s.id];if(o.dependant.length)for(const t of o.dependant){const i=this.data.initialDependant.find(e=>e.id===t),s=this.data.initialDependantData[t],d=o.time.endDate.diff(n.time.endDate,"millisecond"),h=s.time.startDate.add(d,"millisecond"),r=s.time.endDate.add(d,"millisecond"),m=o.position.right-s.position.right,p=o.position.viewTop-s.position.viewTop,c=this.data.snapToTime.start({startTime:h,item:this.api.mergeDeep({},i),time:a,movement:{x:m,y:p,time:d},vido:this.vido});e=(e=e.update(`config.chart.items.${t}.time`,t=>(t.start=c.valueOf(),t.end=r.valueOf(),t))).update(`$data.chart.items.${t}.time`,t=>(t.startDate=c,t.endDate=r,t))}}return e}dispatchEvent(t,e,i=null){"onStart"===t&&(this.api.muteMethod("fixOverlapped"),this.api.muteMethod("fullReload"),this.api.muteMethod("prepareExpanded"),this.api.muteMethod("calculateRowsHeight"),this.api.muteMethod("recalculateRowPercents"),this.api.muteMethod("getLastPageRowsHeight"),this.api.muteMethod("calculateVerticalScrollArea"),this.api.muteMethod("calculateVisibleRowsHeights"),this.api.muteMethod("generateVisibleRowsAndItems"),this.api.muteMethod("recalculateTimes"),this.api.muteMethod("heightChange")),"onEnd"===t&&(this.api.unmuteMethod("fixOverlapped"),this.api.unmuteMethod("heightChange"),this.api.unmuteMethod("recalculateTimes"),this.api.unmuteMethod("generateVisibleRowsAndItems"),this.api.unmuteMethod("calculateVisibleRowsHeights"),this.api.unmuteMethod("calculateVerticalScrollArea"),this.api.unmuteMethod("getLastPageRowsHeight"),this.api.unmuteMethod("recalculateRowPercents"),this.api.unmuteMethod("calculateRowsHeight"),this.api.unmuteMethod("prepareExpanded"),this.api.unmuteMethod("fullReload"),this.api.recalculateRowsHeights(this.state.get("$data.list.visibleRows"))),e=e.map(t=>this.api.mergeDeep({},t));const a=this.data.events[t](this.getEventArgument(e));let s=this.state.multi();for(const t of a)s=s.update(`config.chart.items.${t.id}.time`,t.time),s=s.update(`config.chart.items.${t.id}.rowId`,t.rowId),i&&(s=s.update("$data.chart.items."+t.id,i[t.id]));"onStart"!==t&&"onMove"!==t||(s=this.moveDependantItems(a,s)),s.done()}getItemsForDiff(){const t=this.getSelectedItems()[0],e=this.data.initialItems.find(e=>e.id===t.id);return{modified:t,original:e}}triggerDown(){const t=this.data.triggerDown;this.data.triggerDown=!1,document.body.classList.add(this.data.bodyClass),this.data.isMoving=!0,this.data.initialItems=this.getSelectedItems(),this.data.initialDependant=this.getDependantItems(),this.data.initialItemsData=this.getSelectedItemsData(this.data.initialItems),this.data.initialDependantData=this.getDependantItemsData(),this.data.targetData=this.api.mergeDeep({},t.target.vido),this.data.currentPosition=Object.assign({},this.data.initialPosition),""!==this.data.state&&"end"!==this.data.state||(this.data.state="move"),this.dispatchEvent("onStart",this.data.initialItems),this.updateData()}onPointerDown(t){if(!this.data.enabled)return;this.data.initialPosition={x:t.screenX,y:t.screenY};const e=t.target,i=this.api.getClass("chart-timeline-items-row-item");let a;a=e.classList.contains(i)?e.vido:e.closest("."+i).vido,this.data.triggerDown=t}moveItemVertically(t,e){const i=this.data.movement.y,a=this.data.initialItemsData[t.id],s=this.api.getVisibleRowsId(),n=this.api.getRows(s);for(const s of n){let n=a.position.viewTop+i;if(n<0&&(n=0),n<=s.$data.position.viewTop){t.rowId=s.id,e.position.viewTop=s.$data.position.viewTop,e.position.top=0;break}}}onPointerMove(t){if(!this.data.enabled)return;const e=Math.abs(t.screenX-this.data.initialPosition.x),i=Math.abs(t.screenY-this.data.initialPosition.y);if(this.data.triggerDown&&(e>this.data.threshold.horizontal||i>this.data.threshold.vertical)&&this.triggerDown(),!this.data.isMoving)return;this.data.triggerDown=!1,t.stopPropagation(),t.preventDefault(),this.data.currentPosition.x=t.screenX,this.data.currentPosition.y=t.screenY,this.data.movement.x=this.data.currentPosition.x-this.data.initialPosition.x,this.data.movement.y=this.data.currentPosition.y-this.data.initialPosition.y;const{original:a,modified:s}=this.getItemsForDiff();if(!a)return;this.data.movement.time=s.time.start-a.time.start,"move"!==this.data.state&&"start"!==this.data.state||(this.data.state="move");const n=this.getSelectedItems(),o={},d=this.data.movement,h=this.state.get("$data.chart.time");for(let t=0,e=n.length;t<e;t++){const e=n[t],i=this.api.mergeDeep({},this.data.initialItemsData[e.id]);this.moveItemVertically(e,i);const a=i.time.endDate.diff(i.time.startDate,"millisecond");i.position.left=i.position.left+d.x;const s=this.api.time.getTimeFromViewOffsetPx(i.position.left,h,!0),r=this.data.snapToTime.start({startTime:this.api.time.date(s),item:e,time:h,movement:d,vido:this.vido}),m=r.add(a,"millisecond");e.time.start=r.valueOf(),e.time.end=m.valueOf(),i.time.startDate=r,i.time.endDate=m,i.position.right=i.position.left+i.width,o[e.id]=i}this.dispatchEvent("onMove",n,o),this.updateData()}onEnd(){const t=this.getSelectedItems();this.dispatchEvent("onEnd",t)}onPointerUp(t){this.data.triggerDown=!1,document.body.classList.remove(this.data.bodyClass),this.data.enabled&&this.data.isMoving&&(t.preventDefault(),t.stopPropagation(),"move"===this.data.state&&(this.data.state="end"),this.data.isMoving=!1,this.onEnd(),this.updateData())}itemUpdateAction(t,e){this.data.initialItems.find(t=>t.id===e.item.id)&&this.data.isMoving?t.classList.add(this.data.itemClass):t.classList.remove(this.data.itemClass)}itemAction(t,e){return t.addEventListener("pointerdown",this.onPointerDown),this.itemUpdateAction(t,e),{update:this.itemUpdateAction,destroy:t=>{t.removeEventListener("pointerdown",this.onPointerDown)}}}}t.Plugin=function(t={}){return function(a){const s=a.state.get(e);s&&(t=a.api.mergeDeep({},t,s));return new i(a,t).destroy}},Object.defineProperty(t,"__esModule",{value:!0})}));
